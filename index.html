<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate Way â€” Admin Dashboard (Pi Testnet)</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #6a1b9a; 
            --secondary: #fb8c00; 
            --bg: #f3f4f6; 
            --text: #1f2937; 
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
        }
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; display: flex; justify-content: center; align-items: flex-start; 
            min-height: 100vh; padding: 2rem 1rem; box-sizing: border-box;
        }
        
        .container { 
            background: white; padding: 2rem; border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 900px; 
        }

        h1 { color: var(--primary); text-align: center; margin-bottom: 0.5rem; font-weight: 800;}
        p.subtitle { text-align: center; color: #666; font-size: 0.95rem; margin-bottom: 1.5rem; }

        .tabs { 
            display: flex; flex-wrap: wrap; justify-content: center; 
            margin-bottom: 2rem; background: #f9fafb; padding: 5px; 
            border-radius: 12px; border: 1px solid var(--border);
        }
        .tab-btn {
            flex: 1; min-width: 120px; padding: 12px; border: none; background: transparent; 
            font-family: inherit; font-weight: bold; cursor: pointer; 
            border-radius: 8px; transition: 0.3s; color: #6b7280; font-size: 0.95rem;
        }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .form-section { display: none; animation: fadeIn 0.4s ease; }
        .form-section.active { display: block; }

        .row { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 1.2rem; }
        @media(min-width: 600px) { .row { grid-template-columns: 1fr 1fr; } }
        .form-group { text-align: right; margin-bottom: 1.2rem;}
        .row .form-group { margin-bottom: 0; }
        
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151; font-size: 0.9rem;}
        input, select, textarea { 
            width: 100%; padding: 12px; border: 2px solid var(--border); 
            border-radius: 10px; box-sizing: border-box; font-family: inherit; font-size: 0.95rem; transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--secondary); outline: none; }
        textarea { min-height: 100px; resize: vertical; }

        .section-divider { border: 0; border-top: 2px dashed #e5e7eb; margin: 2rem 0; }
        h3.section-title { color: #4b5563; font-size: 1.1rem; margin-bottom: 1rem; border-right: 4px solid var(--primary); padding-right: 10px;}

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 1rem; }
        .btn { 
            background: #f3f4f6; color: #374151; border: 1px solid var(--border); 
            padding: 12px 20px; border-radius: 10px; font-size: 0.95rem; cursor: pointer; 
            font-weight: bold; transition: 0.3s; font-family: inherit; flex: 1; min-width: 150px;
        }
        .btn:hover { background: #e5e7eb; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #4a148c); color: white; border: none; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(106, 27, 154, 0.2); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary), #e65100); color: white; border: none; }
        .btn-secondary:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(251, 140, 0, 0.2); }
        .btn-danger { background: var(--danger); color: white; border: none; }

        .alert { background: #fffbeb; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; color: #92400e; border: 1px solid #fcd34d; line-height: 1.5; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¸Ù…Ø© (Data Tables) */
        .table-container { overflow-x: auto; margin-top: 1.5rem; border-radius: 12px; border: 1px solid var(--border); background: white; }
        table { width: 100%; border-collapse: collapse; text-align: right; font-size: 0.9rem; }
        th { background: #f9fafb; padding: 12px 15px; font-weight: bold; color: #374151; border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); color: #4b5563; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #f3f4f6; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Toast) */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px;
            position: fixed; z-index: 1000; left: 50%; transform: translateX(-50%);
            bottom: 30px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-family: inherit; font-weight: bold;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 3.5s; }
        #toast.success { background-color: var(--success); }
        #toast.error { background-color: var(--danger); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ (Pi Network)</h1>
        <p class="subtitle">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆÙƒÙŠÙ†Ø§ØªØŒ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©ØŒ ÙˆØ§Ù„Ø³ÙˆÙ‚</p>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dash', this)">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button class="tab-btn" onclick="switchTab('ops', this)">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø³ÙŠÙˆÙ„Ø©</button>
            <button class="tab-btn" onclick="switchTab('tools', this)">Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</button>
            <button class="tab-btn" onclick="switchTab('market', this)">Ù…Ø³ØªÙƒØ´Ù Ø§Ù„Ø³ÙˆÙ‚</button>
            <button class="tab-btn" onclick="switchTab('domain', this)">Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (TOML)</button>
        </div>

        <div id="dash" class="form-section active">
            <div class="alert">âš ï¸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸".</div>
            
            <div class="row">
                <div class="form-group">
                    <label>Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© (Asset Code)</label>
                    <input type="text" id="assetCode" placeholder="Ù…Ø«Ø§Ù„: DONATEWAY">
                </div>
                <div class="form-group">
                    <label>Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù† (Backend Token)</label>
                    <input type="password" id="adminToken" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ©...">
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ÙØµØ¯Ø± (Issuer Pub)</label>
                    <input type="text" id="issuerPub" placeholder="GBQ3H...">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ÙˆØ²Ø¹ (Distributor Pub)</label>
                    <input type="text" id="distPub" placeholder="GCLLM...">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="saveLocal()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹</button>
                <button class="btn btn-primary" onclick="fetchHorizonAsset()">ğŸ”„ ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø¨Ù„ÙˆÙƒØªØ´ÙŠÙ†</button>
            </div>

            <div id="assetStatsContainer"></div>
        </div>

        <div id="ops" class="form-section">
            <h3 class="section-title">Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© (Bootstrap)</h3>
            <div class="row">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ (Display Name)</label>
                    <input type="text" id="displayName" value="Donate Way">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© (Initial Supply)</label>
                    <input type="number" id="initialSupply" value="1000000">
                </div>
            </div>
            <button id="btnBootstrap" class="btn btn-primary" style="width: 100%;">ğŸš€ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ù…ÙˆØ²Ø¹</button>

            <hr class="section-divider">

            <h3 class="section-title">Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¢Ù„ÙŠØ© (DEX)</h3>
            <div class="row">
                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ© (Token Amount)</label>
                    <input type="number" id="dexAmount" value="10">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ø¹Ø± (Pi Ù„ÙƒÙ„ ØªÙˆÙƒÙŠÙ†)</label>
                    <input type="number" id="dexPrice" value="0.05" step="0.01">
                </div>
            </div>
            <div class="btn-group">
                <button id="btnSellOffer" class="btn">ğŸ“‰ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø¨ÙŠØ¹ (Ø¨ÙŠØ¹ Ø§Ù„ØªÙˆÙƒÙŠÙ†)</button>
                <button id="btnBuyOffer" class="btn btn-secondary">ğŸ“ˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø´Ø±Ø§Ø¡ (Ø´Ø±Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙŠÙ†)</button>
            </div>

            <hr class="section-divider">

            <h3 class="section-title">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (AMM)</h3>
            <div class="row">
                <div class="form-group">
                    <label>ÙƒÙ…ÙŠØ© Ø§Ù„ØªÙˆÙƒÙŠÙ† Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹</label>
                    <input type="number" id="ammTokenAmount" value="5000">
                </div>
                <div class="form-group">
                    <label>ÙƒÙ…ÙŠØ© Pi Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹</label>
                    <input type="number" id="ammPiAmount" value="50">
                </div>
            </div>
            <button id="btnAddAmm" class="btn btn-primary" style="width: 100%;">âš™ï¸ Ø¶Ø® Ø§Ù„Ø³ÙŠÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…Ø¹</button>
        </div>

        <div id="tools" class="form-section">
            <h3 class="section-title">ÙØ§Ø­Øµ Ø®Ø·ÙˆØ· Ø§Ù„Ø«Ù‚Ø© (Trustline Checker)</h3>
            <div class="form-group">
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ÙØ­ØµÙ‡Ø§</label>
                <input type="text" id="trustAccount" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ G Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...">
            </div>
            <button class="btn btn-secondary" onclick="checkTrustline()">ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
            <div id="trustlineResult"></div>

            <hr class="section-divider">

            <h3 class="section-title">Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…Ù‘Ø¹ (Airdrop / Mass Payment)</h3>
            <div class="form-group">
                <label>Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙØ¸ (ÙƒÙ„ Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø³Ø·Ø±)</label>
                <textarea id="airdropAddresses" placeholder="GBQ3H...\nGCLLM..."></textarea>
            </div>
            <div class="form-group">
                <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ù„ÙƒÙ„ Ù…Ø­ÙØ¸Ø©</label>
                <input type="number" id="airdropAmount" value="10">
            </div>
            <button id="btnAirdrop" class="btn btn-primary" style="width: 100%;">ğŸ’¸ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>

            <hr class="section-divider">

            <h3 class="section-title" style="border-color: var(--danger); color: var(--danger);">Ø­Ø±Ù‚ Ø§Ù„ØªÙˆÙƒÙŠÙ† (Token Burning)</h3>
            <div class="form-group">
                <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø±Ù‚Ù‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</label>
                <input type="number" id="burnAmount" placeholder="1000">
            </div>
            <button id="btnBurn" class="btn btn-danger" style="width: 100%;">ğŸ”¥ Ø­Ø±Ù‚ Ø§Ù„ØªÙˆÙƒÙŠÙ†</button>
        </div>

        <div id="market" class="form-section">
            <h3 class="section-title">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© (Live Orderbook)</h3>
            <div class="row">
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
                    <select id="obMode">
                        <option value="asks">Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¨ÙŠØ¹ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ (Asks)</option>
                        <option value="bids">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ (Bids)</option>
                    </select>
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="fetchOrderbook()">ğŸ“‹ ØªØ­Ù…ÙŠÙ„ Ø¯ÙØªØ± Ø§Ù„Ø³ÙˆÙ‚</button>
                </div>
            </div>
            <div id="marketTableContainer"></div>
            
            <hr class="section-divider">
            <button class="btn btn-secondary" style="width: 100%;" onclick="fetchPoolInfo()">ğŸ’§ Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©</button>
            <div id="poolTableContainer"></div>
        </div>

        <div id="domain" class="form-section">
            <h3 class="section-title">ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (pi.toml)</h3>
            <div class="row">
                <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¸Ù…Ø©</label><input type="text" id="verOrgName" value="Donate Way"></div>
                <div class="form-group"><label>Ø§Ù„Ù†Ø·Ø§Ù‚ (Domain)</label><input type="text" id="verDomain" value="donateway.netlify.app"></div>
            </div>
            <div class="row">
                <div class="form-group"><label>Ø§Ù„ÙˆØµÙ</label><input type="text" id="verDesc" value="Donate Way token on Pi Testnet."></div>
                <div class="form-group"><label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØ¬Ùˆ</label><input type="text" id="verImage" value="https://donateway.netlify.app/logo.png"></div>
            </div>
            <button id="btnGenPiToml" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">ğŸ“ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ TOML</button>
            <textarea id="tomlOut" readonly style="background: #f9fafb; direction: ltr; font-family: monospace; height: 260px;"></textarea>

            <hr class="section-divider">
            <h3 class="section-title">Ø±Ø¨Ø· Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© (Set Home Domain)</h3>
            <div class="row">
                <div class="form-group"><label>Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† (Ø¨Ø¯ÙˆÙ† https)</label><input type="text" id="hdDomain" value="donateway.netlify.app"></div>
                <div class="form-group" style="display:flex; align-items:flex-end; gap:10px;">
                    <button id="btnSetHomeDomain" class="btn btn-secondary">ğŸ”— ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¨Ø·</button>
                    <button class="btn" onclick="checkHomeDomain()">ğŸ” ÙØ­Øµ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†</button>
                </div>
            </div>
            <div id="domainResult"></div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        const BACKEND_URL = ""; // ÙŠØªÙ… ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ©
        const HORIZON = "https://api.testnet.minepi.com";

        // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI Functions) ---
        function switchTab(tabId, btn) {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = `show ${type}`;
            setTimeout(() => { toast.className = toast.className.replace(/show|success|error/g, "").trim(); }, 4000);
        }

        function renderTable(headers, rows, containerId) {
            const container = document.getElementById(containerId);
            if (rows.length === 0) {
                container.innerHTML = `<div class="alert">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.</div>`;
                return;
            }
            let html = `<div class="table-container"><table><thead><tr>`;
            headers.forEach(h => html += `<th>${h}</th>`);
            html += `</tr></thead><tbody>`;
            rows.forEach(row => {
                html += `<tr>`;
                row.forEach(cell => html += `<td>${cell}</td>`);
                html += `</tr>`;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function normalize(code) { return (code || "").toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 12); }

        // --- Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ (Local Storage) ---
        function saveLocal() {
            const data = {
                code: document.getElementById('assetCode').value,
                admin: document.getElementById('adminToken').value,
                issuer: document.getElementById('issuerPub').value,
                dist: document.getElementById('distPub').value
            };
            localStorage.setItem('piAdminSettings', JSON.stringify(data));
            showToast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ù†Ø¬Ø§Ø­.");
        }

        function loadLocal() {
            const saved = localStorage.getItem('piAdminSettings');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('assetCode').value = data.code || "";
                document.getElementById('adminToken').value = data.admin || "";
                document.getElementById('issuerPub').value = data.issuer || "";
                document.getElementById('distPub').value = data.dist || "";
            }
        }
        window.onload = loadLocal;

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ù„ÙˆÙƒØªØ´ÙŠÙ† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Horizon API - Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©) ---
        async function fetchHorizonAsset() {
            const code = normalize(document.getElementById('assetCode').value);
            const issuer = document.getElementById('issuerPub').value.trim();
            if (!code || !issuer) return showToast("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆÙ…ÙØªØ§Ø­ Ø§Ù„Ù…ÙØµØ¯Ø± Ø£ÙˆÙ„Ø§Ù‹.", "error");

            try {
                showToast("â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¨Ù„ÙˆÙƒØªØ´ÙŠÙ†...");
                const res = await fetch(`${HORIZON}/assets?asset_code=${code}&asset_issuer=${issuer}`);
                const data = await res.json();
                
                if (data._embedded && data._embedded.records.length > 0) {
                    const asset = data._embedded.records[0];
                    
                    // ğŸ’¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø­Ø±ÙŠ: Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ Horizon API
                    const totalSupply = asset.amount || (asset.balances && asset.balances.authorized) || "0";
                    const holdersCount = asset.num_accounts || (asset.accounts && asset.accounts.authorized) || "0";
                    
                    renderTable(
                        ["Ù…Ø¹Ù„ÙˆÙ…Ø©", "Ø§Ù„Ù‚ÙŠÙ…Ø©"],
                        [
                            ["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ (Supply)", `<span class="badge badge-green">${totalSupply} ${code}</span>`],
                            ["Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„ØªÙŠ ØªÙ…ØªÙ„Ùƒ Ø§Ù„Ø¹Ù…Ù„Ø© (Holders)", `<span class="badge badge-green">${holdersCount} Ù…Ø­ÙØ¸Ø©</span>`],
                            ["Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¹Ø© Ù„Ù„Ø«Ù‚Ø©", asset.num_claimable_balances || "0"],
                            ["Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„Ø© (Asset Type)", asset.asset_type]
                        ],
                        "assetStatsContainer"
                    );
                    showToast("âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.");
                } else {
                    renderTable(["Ø§Ù„Ù†ØªÙŠØ¬Ø©"], [["Ø§Ù„Ø¹Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©ØŒ Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø±Ù‡Ø§ Ø¨Ø¹Ø¯."]], "assetStatsContainer");
                }
            } catch (e) {
                console.error(e);
                showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø¨ÙƒØ© Horizon.", "error");
            }
        }

        async function checkTrustline() {
            const code = normalize(document.getElementById('assetCode').value);
            const issuer = document.getElementById('issuerPub').value.trim();
            const account = document.getElementById('trustAccount').value.trim();
            
            if (!account) return showToast("âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ù„ÙØ­Øµ.", "error");
            if (!code || !issuer) return showToast("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ Ù†Ø§Ù‚ØµØ©.", "error");

            try {
                const res = await fetch(`${HORIZON}/accounts/${account}`);
                if (!res.ok) throw new Error("Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©.");
                const data = await res.json();
                
                const hasTrust = data.balances.some(b => b.asset_code === code && b.asset_issuer === issuer);
                
                const status = hasTrust 
                    ? `<span class="badge badge-green">âœ… Ù†Ø¹Ù…ØŒ ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¹Ù…Ù„Ø©</span>` 
                    : `<span class="badge badge-red">âŒ Ù„Ø§ØŒ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© Ø®Ø· Ø§Ù„Ø«Ù‚Ø©</span>`;
                
                renderTable(["Ø§Ù„Ù…Ø­ÙØ¸Ø©", "Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ù‚Ø© (Trustline)", "Ø±ØµÙŠØ¯ Pi"], [[account.slice(0,8)+"...", status, data.balances.find(b=>b.asset_type==='native')?.balance || 0]], "trustlineResult");
            } catch (e) {
                renderTable(["Ø®Ø·Ø£"], [[e.message]], "trustlineResult");
            }
        }

        async function fetchOrderbook() {
            const code = normalize(document.getElementById('assetCode').value);
            const issuer = document.getElementById('issuerPub').value.trim();
            const mode = document.getElementById('obMode').value; // asks or bids
            
            if (!code || !issuer) return showToast("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© Ù…ÙÙ‚ÙˆØ¯Ø©.", "error");

            try {
                const url = `${HORIZON}/order_book?selling_asset_type=native&buying_asset_type=${code.length>4?'credit_alphanum12':'credit_alphanum4'}&buying_asset_code=${code}&buying_asset_issuer=${issuer}`;
                const res = await fetch(url);
                const data = await res.json();

                const records = mode === 'asks' ? data.asks : data.bids;
                const rows = records.map(r => [r.price, r.amount, r.price_r.n + '/' + r.price_r.d]);
                
                renderTable(["Ø§Ù„Ø³Ø¹Ø± (Pi)", "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©/Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©", "Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©"], rows, "marketTableContainer");
                showToast("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¯ÙØªØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª.");
            } catch (e) {
                showToast("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚.", "error");
            }
        }

        async function checkHomeDomain() {
            const issuer = document.getElementById('issuerPub').value.trim();
            if (!issuer) return showToast("âŒ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙØµØ¯Ø± Ø£ÙˆÙ„Ø§Ù‹.", "error");
            
            try {
                const res = await fetch(`${HORIZON}/accounts/${issuer}`);
                const data = await res.json();
                const hd = data.home_domain ? `<a href="https://${data.home_domain}" target="_blank">${data.home_domain}</a>` : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙˆÙ…ÙŠÙ† Ù…Ø±Ø¨ÙˆØ·.";
                renderTable(["Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ù…Ø±Ø¨ÙˆØ· (Home Domain)"], [[hd]], "domainResult");
            } catch (e) {
                showToast("âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†.", "error");
            }
        }

        async function fetchPoolInfo() {
            showToast("Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù‡Ù†Ø§ (Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙÙŠ Horizon API).");
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ (Netlify Functions) ---
        async function callBackend(path, bodyMsg, successMsg) {
            const admin = document.getElementById('adminToken').value.trim();
            if (!admin) return showToast("âŒ Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø·Ù„ÙˆØ¨ Ù„ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.", "error");
            
            try {
                showToast("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯...");
                const res = await fetch(BACKEND_URL + path, {
                    method: "POST", headers: { "Content-Type": "application/json", "X-Admin-Token": admin },
                    body: JSON.stringify(bodyMsg)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
                showToast(successMsg);
            } catch (e) {
                showToast(`âŒ ÙØ´Ù„: ${e.message}`, "error");
            }
        }

        // --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠØ© ---
        
        // 1. Ø²Ø± Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©
        document.getElementById("btnBootstrap").addEventListener("click", () => {
            callBackend("/.netlify/functions/token_bootstrap", {
                assetCode: normalize(document.getElementById('assetCode').value),
                displayName: document.getElementById("displayName").value,
                initialSupply: document.getElementById("initialSupply").value
            }, "âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
        });

        // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø¨ÙŠØ¹
        document.getElementById("btnSellOffer").addEventListener("click", () => {
            callBackend("/.netlify/functions/dex_sell_offer", {
                assetCode: normalize(document.getElementById('assetCode').value),
                amount: document.getElementById("dexAmount").value,
                price: document.getElementById("dexPrice").value
            }, "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
        });

        // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø´Ø±Ø§Ø¡
        document.getElementById("btnBuyOffer").addEventListener("click", () => {
            callBackend("/.netlify/functions/bot_trade", { 
                assetCode: normalize(document.getElementById('assetCode').value),
                action: "buy_token",
                amount: document.getElementById("dexAmount").value,
                price: document.getElementById("dexPrice").value
            }, "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
        });

        // 4. Ø¶Ø® Ø§Ù„Ø³ÙŠÙˆÙ„Ø©
        document.getElementById("btnAddAmm").addEventListener("click", () => {
            callBackend("/.netlify/functions/amm_add_liquidity", {
                assetCode: normalize(document.getElementById('assetCode').value),
                tokenAmount: document.getElementById("ammTokenAmount").value,
                piAmount: document.getElementById("ammPiAmount").value
            }, "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù„Ù„Ù…Ø¬Ù…Ø¹ Ø¨Ù†Ø¬Ø§Ø­!");
        });

        // 5. Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…Ù‘Ø¹ (Airdrop)
        document.getElementById("btnAirdrop").addEventListener("click", () => {
            const addressesText = document.getElementById("airdropAddresses").value;
            // ÙØµÙ„ Ø§Ù„Ø³Ø·ÙˆØ± ÙˆÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ G
            const addressesArray = addressesText.split('\n').map(a => a.trim()).filter(a => a.length >= 50 && a.startsWith('G'));
            
            if (addressesArray.length === 0) return showToast("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø­ÙØ¸Ø© ÙˆØ§Ø­Ø¯Ø© ØµØ­ÙŠØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.", "error");

            callBackend("/.netlify/functions/airdrop", {
                assetCode: normalize(document.getElementById('assetCode').value),
                addresses: addressesArray,
                amount: document.getElementById("airdropAmount").value
            }, `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø¥Ù„Ù‰ ${addressesArray.length} Ù…Ø­ÙØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
        });

        // 6. Ø­Ø±Ù‚ Ø§Ù„ØªÙˆÙƒÙŠÙ† (Burn)
        document.getElementById("btnBurn").addEventListener("click", () => {
            const amount = document.getElementById("burnAmount").value;
            if (!amount || amount <= 0) return showToast("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø­Ø±Ù‚.", "error");

            if (confirm(`âš ï¸ ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø±Ù‚ ÙˆØ¥Ø¹Ø¯Ø§Ù… ${amount} ØªÙˆÙƒÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`)) {
                callBackend("/.netlify/functions/burn_token", {
                    assetCode: normalize(document.getElementById('assetCode').value),
                    amount: amount
                }, `ğŸ”¥ ØªÙ… Ø­Ø±Ù‚ ${amount} ØªÙˆÙƒÙŠÙ† ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙƒÙ„ÙŠ Ø¨Ù†Ø¬Ø§Ø­!`);
            }
        });

        // 7. ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù TOML (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
        document.getElementById("btnGenPiToml").addEventListener("click", () => {
            const code = document.getElementById("assetCode").value.trim();
            const issuer = document.getElementById("issuerPub").value.trim();
            const orgName = document.getElementById("verOrgName").value.trim();
            const domain = document.getElementById("verDomain").value.trim().replace(/^https?:\/\//, ''); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† https
            const desc = document.getElementById("verDesc").value.trim();
            const image = document.getElementById("verImage").value.trim();
            
            if (!code || !issuer) {
                return showToast("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ (Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©) Ùˆ (Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙØµØ¯Ø±) ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø£ÙˆÙ„Ø§Ù‹.", "error");
            }

            const tomlString = `# Network Info\nNETWORK_PASSPHRASE="Pi Testnet"\nHORIZON_URL="https://api.testnet.minepi.com"\n\n# Organization Info\nORG_NAME="${orgName}"\nORG_URL="https://${domain}"\nORG_DESCRIPTION="${desc}"\nORG_LOGO="${image}"\n\n# Token Info\n[[CURRENCIES]]\ncode="${code}"\nissuer="${issuer}"\ndisplay_decimals=7\nname="${orgName} Token"\ndesc="${desc}"\nimage="${image}"`;
            
            document.getElementById("tomlOut").value = tomlString;
            showToast("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ TOML Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¨Ù†Ø¬Ø§Ø­.");
        });

        // 8. Ø±Ø¨Ø· Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø¨Ø§Ù„Ù…ÙØµØ¯Ø±
        document.getElementById("btnSetHomeDomain").addEventListener("click", () => {
            const domain = document.getElementById("hdDomain").value.trim();
            if (!domain) return showToast("âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡.", "error");

            callBackend("/.netlify/functions/set_domain", {
                domain: domain,
                assetCode: normalize(document.getElementById('assetCode').value)
            }, "âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø¨Ø§Ù„Ù…ÙØµØ¯Ø± Ø¨Ù†Ø¬Ø§Ø­!");
        });
    </script>
</body>
</html>
